
package samoa.core.protobuf;

enum CommandType {

    // Present only in SamoaResponse
    ERROR = 5;

    PING = 1;
    SHUTDOWN = 2;
    GET = 3;
    SET = 4;
    CLUSTER_STATE = 6;

    DECLARE_TABLE = 7;
    DROP_TABLE = 8;

    CREATE_PARTITION = 9;
    DROP_PARTITION = 10;
};

// Returned by Samoa to indicate an error in the operation
message Error {
    required string type = 1;
    optional string message = 2;
};

message ClusterState {

    // A ClusterState represents a consistent snapshot of the cluster
    //  shape and configuration, from the perspective of a cluster
    //  participant.
    //
    // ClusterState messages are periodically passed between samoa
    //  servers for purposes of discovery: to detect unknown peers,
    //  tables, and partitions which should be tracked.

    required string local_uuid = 1;
    required string local_hostname = 2;
    required int32  local_port = 3;

    message Peer {

        // cluster-shared peer state
        required string uuid = 1;
        required string hostname = 2;
        required int32  port = 3;

        // local server statistics
        required bool   connected = 6;
        optional uint32 queue_size = 7;
        optional uint32 latency_ms = 8;
    };
    repeated Peer peer = 4;

    message Table {

        required string uuid = 1;
        optional bool   dropped = 2 [default = false];

        optional string name = 3;
        optional int64  replication_factor = 4;

        message Partition {

            required string uuid = 1;
            optional bool   dropped = 2 [default = false];

            optional string server_uuid = 3;
            optional int64  ring_position = 4;
            optional string storage_path = 5;
            optional int64  storage_size = 6;
            optional int64  index_size = 7;
        };
        repeated Partition partition = 7;
    };
    repeated Table table = 5;
};

// Operations

message PingRequest {
    required int64 value_len = 1 [default = 0];
};
message PingResponse {
    required int64 value_len = 1 [default = 0];
};

// Table Manipulation

message DeclareTableRequest {
    required string name = 1;
    required bool create_if_not_exists = 2 [default = true];
    required int32 replication_factor = 3 [default = 1];
};

message DeclareTableResponse {
    required string uuid = 1;
    required string name = 2;
    required int32 replication_factor = 3;
    required bool created = 4;
};

message DropTableRequest {
    required string uuid = 1;
};

message DropTableResponse {
};

// Partition Manipulation

message CreatePartitionRequest {
    required string table_uuid = 1;
    required int64  ring_position = 2;

    required string storage_size = 3;
    required int64  index_size = 4;
};

message CreatePartitionResponse {
    required string uuid = 1;
};

message DropPartitionRequest {
    required string uuid = 1;
};

message DropPartitionResponse {
    required string uuid = 1;
};

// Table access operations

message GetRequest {
    required string key = 1;
    optional bool allow_blocking = 2 [default = true];
};
message GetResponse {
    required bool  found = 1;
    optional int64 value_length = 2;
};

message SetRequest {
    required string table_uid = 1;
    required string key = 2;
    required bool   replace = 3 [default = true];
    required int64  value_length = 4;
};
message SetResponse {
    required bool   replaced = 1;
};

message SamoaRequest {
    required CommandType type = 1;

    // whether the client will be closing the connection after this request
    optional bool closing = 3 [default = false];

    optional PingRequest      ping = 2;
    optional GetRequest       get = 4;
    optional SetRequest       set = 5;
    optional ClusterState     cluster_state = 7;

    optional DeclareTableRequest declare_table = 8;
    optional DropTableRequest    drop_table = 9;

    optional CreatePartitionRequest create_partition = 10;
    optional DropPartitionRequest   drop_partition = 11;

    // generates an error response
    optional Error            error = 6;
};

message SamoaResponse {
    required CommandType type = 1;

    // whether the server will be closing the connection after this request
    optional bool closing = 6 [default = false];

    optional Error         error = 2;
    optional PingResponse  ping = 3;
    optional GetResponse   get = 4;
    optional SetResponse   set = 5;
    optional ClusterState  cluster_state = 7;

    optional DeclareTableResponse declare_table = 8;
    optional DropTableResponse    drop_table = 9;

    optional CreatePartitionResponse create_partition = 10;
    optional DropPartitionResponse   drop_partition = 11;
};

